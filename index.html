<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biller</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');

      table,
      th,
      td {
        margin: 8px;
      }
      
      tr{
          margin: 5px;
      }

      th{
        background-color: rgb(248, 129, 45);
        color: white;
        border-radius: 5px;
        box-shadow: 2px 2.5px 2.5px 1px grey;
      }
      
      td{
        border-radius: 5px;
        box-shadow: 2px 2.5px 2.5px 1px grey;
      }

      body {
        font-family: 'Roboto', sans-serif;
      }

      #result-div,
      #bill-form {
        width: max-content;
        margin: 0 auto;
        display: block;
      }

      #bill-form {
        margin-top: 20px;
      }

      #whatsapp-send,
      .bill-btn {
        margin: 0 auto;
        display: block;
        cursor: pointer;
        padding: 10px;
        background-color: white;
        border: 0.5px solid black;
        border-radius: 4px;
        box-shadow: 1px 0.5px 0.5px 0.5px grey;
      }

      #result {
        margin-top: 20px;
        border: 1px solid grey;
        border-radius: 8px;
      }

      .fa-whatsapp {
        font-size: 30px;
      }
      
      input[type=number]{
          padding: 10px;
          border: none;
      }

      #manage-div {
        padding: 10px;
        display: none;
      }

      #manage-btn,
      #biller-btn {
        border: 1px solid black;
        cursor: pointer;
        padding: 10px;
      }

      #biller-btn {
        background-color: white;
        border-bottom: none;
      }

      #manage-btn {
        border-bottom: none;
        background-color: grey;
        color: white;
      }

      #main-div {
        display: none;
      }

      #login-div {
        padding: 10%;
        text-align: center;
      }

      #login-div input {
        margin: 5px;
        height: 40px;
        border: 0.5px solid grey;
        border-radius: 5px;
        box-shadow: 2px 3px 0.5px 0.5px grey;
        font-size: 18px;
      }

      h3 {
        font-size: 40px;
        font-family: 'Roboto', sans-serif;
      }

      #login-div button {
        padding: 10px;
        font-size: 15px;
        border-radius: 5px;
        border: 1px solid grey;
        cursor: pointer;
        box-shadow: 1px 0.5px 0.5px 0.5px grey;
        font-family: 'Roboto', sans-serif;
      }

      #login-progress {
        margin: 0 auto;
        display: none;
      }

      input,textarea,select{
        width: inherit;
        height: 20px;
      }
      
      select{
          text-align:center;
          background-color: white;
          width: 100%;
          border: none;
      }
      #date{
          width: 100%;
          padding:0;
          background-color: white;
          border: none;
          text-align: center;
      }
      textarea{
          width: 100%;
          padding:0;
          border:none;
      }
    </style>
  </head>
  <body>
    <div id="login-div">
      <div style="width: max-content; margin: 0 auto;">
        <h3 style="text-align: center;">Login</h3>
        <input type="email" placeholder="Email*" id="email">
        <br>
        <input type="password" placeholder="Password*" id="password">
        <br>
        <button onclick="login();" style="width: max-content; margin: 0 auto; display: block; margin-top: 5px;">Login</button>
        <br>
        <progress id="login-progress"></progress>
      </div>
    </div>
    <div id="main-div">
      <div style="width: max-content;margin: 0 auto;display:block">
        <input type="tel" id="number" placeholder="Enter mobile number" style="width:inherit;height:40px;">
        <br>
        <br>
        <button onclick="openWhatsapp(document.getElementById('number').value);" style="height:30px;" class="bill-btn">Open WhatsApp</button>
      </div>
      <br>
      <div>
        <button onclick="openBiller();" id="biller-btn">Biller</button>
        <button onclick="openManage();" id="manage-btn">Manage</button>
        <div style="border: 1px solid grey; padding: 10px;">
          <div id="manage-div">
            <div id="date-range-div">
              <p>
                <b>Start date</b>: <input type="date" id="start-date">
              </p>
              <p>
                <b>End date</b>: <input type="date" id="end-date">
              </p>
              <button onclick="getDetails();" style="padding: 10px; font-size: large;">Get</button>
              <progress id="get-progress" style="display:none;"></progress>
            </div>
            <br>
            <div style="border: 1px solid grey;" id="manage-details-div">
              <p>
                <b>No. of days: </b>
                <span id="days_work_done"></span>
              </p>
              <p>
                <b>Total Cans: </b>
                <span id="total-cans"></span>
              </p>
              <p>
                <b>Total Milk (in litres): </b>
                <span id="total-cans-weight"></span>
              </p>
              <p>
                <b>Total Amount spent: </b>
                <span id="total-amount"></span>
              </p>
            </div>
          </div>
          <div id="bill-form">
            <table>
              <caption>Milk Biller</caption>
              <tbody>
                <tr>
                  <th>Select Dairy</th>
                  <td>
                    <select id="milk-seller-list"></select>
                  </td>
                </tr>
                <tr>
                  <th>Select Date</th>
                  <td>
                    <input type="date" id="date">
                    </br>
                    <select id="am-pm">
                      <option value="AM">AM</option>
                      <option value="PM">PM</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <th>Enter Weights</th>
                  <td>
                    <textarea id="weights"></textarea>
                  </td>
                </tr>
                <tr>
                  <th>Enter Cans weight</th>
                  <td>
                    <input type="number" id="can-weight">
                  </td>
                </tr>
                <tr>
                  <th>Enter Milk rate</th>
                  <td>
                    <input type="number" id="milk-price">
                  </td>
                </tr>
              </tbody>
            </table>
            <button onclick="calculateResult();" class="bill-btn">Submit</button>
          </div>
          <div>
            <div id="get-bill-div" style="width: max-content; margin: 0 auto; display: none; text-align: center;">
              <p>
                <b>Select bill date</b>
              </p>
              <input type="date" id="bill-date-input">
              <br>
              <br>
              <button onclick="getBill(document.getElementById('bill-date-input').value);">Get Bill</button>
              <br>
              <progress id="get-bill-progress" style="display: none;"></progress>
            </div>
            <div style="display: none;" id="result-div">
              <div id="result"></div>
              </br>
              <button id="whatsapp-send" style="background-color: aliceblue;">
                <i class="fa fa-whatsapp"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <script>

        function getBill(reqDate) {
          document.getElementById('get-bill-progress').style.display = 'block';
          db.collection("Milk Biller").doc(reqDate).get().then((doc) => {
            if (doc.exists) {
                document.getElementById('get-bill-progress').style.display = 'none';
                var dairyName = doc.data().Milk_Partner;
                var date = doc.data().Date;
                var am_pm = doc.data().AM_PM;
                var weights = doc.data().Weights;
                var weightsString = "";
                var weightsString1 = "";
                let bill = getTotalWeight(weights);
                var canWeight = doc.data().Can_Weight;
                let weight = parseFloat(bill - canWeight).toFixed(3);

                for(let i=0;i<weights.length;i++){
                    weightsString += weights[i] + "%0A";
                    weightsString1 += weights[i] + "  </br>";
                }
                
                var totalAmount = doc.data().Total_Bill;
                var milk_rate = doc.data().Milk_Rate_Per_Litre;
                var result_wa = createWhatsappString(dairyName, new Date(date).toLocaleDateString("en-GB"), am_pm, weightsString, canWeight, weight, totalAmount, bill, milk_rate);
                var result_div = createDivString(dairyName, new Date(date).toLocaleDateString("en-GB"), am_pm, weightsString1, bill, milk_rate, canWeight, weight, totalAmount);
                document.getElementById('result-div').style.display = 'block';
                document.getElementById('result').innerHTML = result_div;
                document.getElementById('whatsapp-send').addEventListener('click', () => {
                    window.location.href = createWhatsAppLink(result_wa);
                });
            } 
            else {
                document.getElementById('get-bill-progress').style.display = 'none';
                alert("No bill found");
            }
          }).catch((error) => {
            console.log("Error getting document:", error);
            document.getElementById('get-bill-progress').style.display = 'none';
          });
        }

        if (sessionStorage.getItem('login-status') == null || sessionStorage.getItem('login-status') == false) {
          showLoginDiv(true);
          showMainDiv(false);
        } else {
          showLoginDiv(false);
          showMainDiv(true);
        }

        function login() {
          document.getElementById('login-progress').style.display = "block";
          email = document.getElementById('email').value;
          password = document.getElementById('password').value;
          firebase.auth().signInWithEmailAndPassword(email, password).then((userCredential) => {
            // Signed in
            var user = userCredential.user;
            showLoginDiv(false);
            document.getElementById('login-progress').style.display = "none";
            showMainDiv(true);
            sessionStorage.setItem('login-status', true);
            // ...
          }).catch((error) => {
            var errorCode = error.code;
            var errorMessage = error.message;
            document.getElementById('login-progress').style.display = "none";
            alert('You are not allowed to sign in. Kindly contact SVRMP about this error.');
          });
        }

        function showLoginDiv(show) {
          if (show) {
            document.getElementById('login-div').style.display = "block";
          } else {
            document.getElementById('login-div').style.display = "none";
          }
        }

        function showMainDiv(show) {
          if (show) {
            document.getElementById('main-div').style.display = "block";
          } else {
            document.getElementById('main-div').style.display = "none";
          }
        }
        no_of_days = parseInt(0);
        amount_spent = parseInt(0);
        total_cans = parseInt(0);
        total_cans_weight = parseInt(0);

        function getDetails() {
          var db = firebase.firestore();
          var startDate = document.getElementById('start-date').value;
          var endDate = document.getElementById('end-date').value;
          if (startDate != null && endDate != null) {
            document.getElementById('get-progress').style.display = 'block';
            db.collection("Milk Biller").where("Date", ">=", startDate).where("Date", "<=", endDate).get().then((querySnapshot) => {
              querySnapshot.forEach((doc) => {
                no_of_days++;
                amount = doc.data().Total_Bill.split(',');
                amount_spent += parseInt(amount[0] + '' + amount[1]);
                total_cans += doc.data().Cans_Count;
                total_cans_weight += parseFloat(doc.data().Bill_Without_Can_Weight) - parseFloat(doc.data().Can_Weight);
              });
              document.getElementById('get-progress').style.display = 'none';
              document.getElementById('days_work_done').innerText = no_of_days;
              document.getElementById('total-cans').innerText = total_cans;
              document.getElementById('total-cans-weight').innerText = Intl.NumberFormat('en-IN').format(total_cans_weight);
              document.getElementById('total-amount').innerText = "₹ " + Intl.NumberFormat('en-IN').format(amount_spent) + "/-";
              no_of_days = parseInt(0);
              amount_spent = parseInt(0);
              total_cans = parseInt(0);
              total_cans_weight = parseInt(0);
            }).catch((error) => {
              console.log("Error getting documents: ", error);
            });
          }
        }

        function openBiller() {
          document.getElementById('bill-form').style.display = 'block';
          document.getElementById('manage-div').style.display = 'none';
          document.getElementById('result-div').style.display = 'block';
          document.getElementById('get-bill-div').style.display = 'none';
          document.getElementById('manage-btn').style = "background-color: grey; color: white; border-bottom: none;";
          document.getElementById('biller-btn').style = "background-color: white; border-bottom: none;";
        }

        function openManage() {
          document.getElementById('bill-form').style.display = 'none';
          document.getElementById('manage-div').style.display = 'block';
          document.getElementById('result-div').style.display = 'block';
          document.getElementById('get-bill-div').style.display = 'block';
          document.getElementById('biller-btn').style = "background-color: grey; color: white; border-bottom: none;";
          document.getElementById('manage-btn').style = "background-color: white; border-bottom: none; color: black;";
        }

        function openWhatsapp(number) {
          window.location.href = "https://api.whatsapp.com/send?phone=+91" + number;
        }
        if (localStorage.getItem("result_div") != null && localStorage.getItem("wa") != null) {
          var div = document.getElementById('result');
          document.getElementById("result-div").style.display = 'block';
          div.innerHTML = localStorage.getItem("result_div");
          div.style.display = 'block';
          document.getElementById("whatsapp-send").addEventListener('click', () => {
            window.location.href = createWhatsAppLink(localStorage.getItem("wa"));
          });
        }
        var textarea = document.getElementById('weights');
        var heightLimit = 200;
        textarea.oninput = function() {
          textarea.style.height = "";
          textarea.style.height = Math.min(textarea.scrollHeight, heightLimit) + "px";
        }

        function calculateResult() {
          var weights = document.getElementById('weights');
          var result = document.getElementById('result');
          var resultText = weights.value;
          result.innerHTML = alignBill(resultText);
          document.getElementById('result-div').style.display = 'block';
        }

        function computeTotal(quantities) {
          var weights = quantities.split('\n');
          let sum = 0;
          for (let i = 0; i < weights.length; i++) {
            sum += parseFloat(weights[i]);
          }
          return sum.toFixed(3);
        }

        function getTotalWeight(weights) {
          let sum = 0;
          for (let i = 0; i < weights.length; i++) {
            sum += parseFloat(weights[i]);
          }
          return sum.toFixed(3);
        }

        function alignBill(quantities) {
          let bill = computeTotal(quantities);
          let milk_rate = parseFloat(document.getElementById('milk-price').value);
          let canWeight = parseFloat(document.getElementById('can-weight').value).toFixed(3);
          var dairyName = document.getElementById('milk-seller-list').value;
          let weight = parseFloat(bill - canWeight).toFixed(3);
          let totalAmount = parseFloat(weight * milk_rate).toFixed(0);
          totalAmount = Intl.NumberFormat('en-IN').format(totalAmount);
          var date1 = document.getElementById('date').value;
          var date = new Date(date1).toLocaleDateString("en-GB");
          var am_pm = document.getElementById('am-pm').value;
          var weights = quantities.split('\n');
          var weightsString = "";
          var weightsString1 = "";
          for (let i = 0; i < weights.length; i++) {
            weightsString += weights[i] + "%0A";
            weightsString1 += weights[i] + "</br>";
          }
          var result_wa = createWhatsappString(dairyName, date, am_pm, weightsString, canWeight, weight, totalAmount, bill, milk_rate);
          var result_div = createDivString(dairyName, date, am_pm, weightsString1, bill, milk_rate, canWeight, weight, totalAmount);
          addToDB(date1, dairyName, weights, bill, canWeight, milk_rate, totalAmount, am_pm);
          addToLS(result_div, result_wa);
          document.getElementById('whatsapp-send').addEventListener('click', () => {
            window.location.href = createWhatsAppLink(result_wa);
          });
          return result_div;
        }

        function createWhatsappString(dairyName,date,am_pm,weightsString,canWeight,weight,totalAmount,bill,milk_rate){
          return "*" + dairyName + "*%0A*Date*: " + date + " _(" + am_pm + ")_%0A%0A" + weightsString + "————————%0A*" + bill + "*%0A" + "– _" + canWeight + "_ (Empty Cans)%0A——————————%0A_*" + weight + "*_ × " + milk_rate + "%0A———————%0A*₹ " + totalAmount + "/-*";
        }
      
        function createDivString(dairyName,date,am_pm,weightsString1,bill,milk_rate,canWeight,weight,totalAmount){
            return "<b>"+dairyName+"</b></br><b>Date</b>: "+date+"<i>("+am_pm+") </i> </br> </br>"+weightsString1+"------------- </br> <b> "+bill+" </b> </br>"+"–  <i> "+canWeight+" </b> <i> (Empty Cans) </i> </br>------------- </br>"+weight+" × "+milk_rate+" </br>------------- </br> <b> ₹"+totalAmount+" / - </b>";
        }

        function createWhatsAppLink(message) {
          return "whatsapp://send?text=" + message;
        }

        function addToLS(div, wa) {
          localStorage.setItem("result_div", div);
          localStorage.setItem("wa", wa);
        }

        function addToDB(date, milkpartner, weights, bill, canweight, milkrate, totalBill, am_pm) {
          var db = firebase.firestore();
          db.collection("Milk Biller").doc(date).set({
            Date: date,
            AM_PM: am_pm,
            Milk_Partner: milkpartner,
            Weights: weights,
            Cans_Count: weights.length,
            Bill_Without_Can_Weight: bill,
            Can_Weight: canweight,
            Milk_Rate_Per_Litre: milkrate,
            Total_Bill: totalBill
          }).then(() => {
            console.log("Document successfully written!");
          }).catch((error) => {
            console.error("Error writing document: ", error);
          });
        }

        function initDB() {
          const firebaseConfig = {
            apiKey: "AIzaSyABU3wrmKgVumYiW6MVBWn5CFg20k2LkiE",
            authDomain: "srivenkataramanamilk-products.firebaseapp.com",
            databaseURL: "https://srivenkataramanamilk-products-default-rtdb.firebaseio.com",
            projectId: "srivenkataramanamilk-products",
            storageBucket: "srivenkataramanamilk-products.appspot.com",
            messagingSenderId: "305866360345",
            appId: "1:305866360345:web:3919e57a4360fd2cdb0c88",
            measurementId: "G-LCHPSC45B5"
          };
          firebase.initializeApp(firebaseConfig);
        }
        initDB();
        var db = firebase.firestore();
        db.collection("Milk Sellers").get().then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            var option = document.createElement('option');
            option.value = doc.data().Seller_Name + ", " + doc.data().Seller_Place;
            option.innerText = doc.id;
            document.getElementById('milk-seller-list').appendChild(option);
          });
        });
        db.collection("Milk Biller").orderBy("Date", "desc").limit(1).get().then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
                var latest = doc.data().Date.split("-");
                var dd = latest[2];
                var mm = latest[1];
                var yyyy = latest[0];

                today = yyyy+"-"+mm+"-"+dd;
                getBill(today);
          });
        });
        
        var date = new Date();

        var day = date.getDate();
        var month = date.getMonth() + 1;
        var year = date.getFullYear();

        if (month < 10) month = "0" + month;
        if (day < 10) day = "0" + day;

        var today = year + "-" + month + "-" + day;       
        document.getElementById("date").value = today;
      </script>
    </div>
  </body>
</html>
