<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biller</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <style>
      table,
      th,
      td {
        border: 1px solid black;
        margin: 8px;
      }

      #result-div,
      #bill-form {
        width: max-content;
        margin: 0 auto;
        display: block;
      }

      #bill-form {
        margin-top: 100px;
      }

      button {
        margin: 0 auto;
        display: block;
        border-radius: 4px;
      }

      #result {
        margin-top: 20px;
        border: 1px solid grey;
        border-radius: 8px;
      }

      .fa-whatsapp {
        font-size: 30px;
      }
    </style>
  </head>
  <body>
    <div style="width: max-content;margin: 0 auto;display:block">
      <input type="number" id="number" placeholder="Enter mobile number" style="width:inherit;height:40px;">
      <br>
      <br>
      <button onclick="openWhatsapp(document.getElementById('number').value);" style="height:30px;">Open WhatsApp</button>
    </div>
    <div id="bill-form">
      <table>
        <caption>Milk Biller</caption>
        <tbody>
          <tr>
            <th>Select Dairy</th>
            <td>
              <input type="radio" id="milk-seller-lakshmi-sai">Lakshmi Sai Diary
            </td>
          </tr>
          <tr>
            <th>Select Date</th>
            <td>
              <input type="date" id="date">
              </br>
              <select id="am-pm">
                <option value="AM">AM</option>
                <option value="PM">PM</option>
              </select>
            </td>
          </tr>
          <tr>
            <th>Enter Weights</th>
            <td>
              <textarea id="weights"></textarea>
            </td>
          </tr>
          <tr>
            <th>Enter Cans weight</th>
            <td>
              <input type="number" id="can-weight">
            </td>
          </tr>
          <tr>
            <th>Enter Milk rate</th>
            <td>
              <input type="number" id="milk-price">
            </td>
          </tr>
          <tr>
            <td></td>
            <td>
              <button onclick="calculateResult();">Submit</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div style="display: none;" id="result-div">
      <div id="result"></div>
      </br>
      <button id="whatsapp-send" style="background-color: aliceblue;">
        <i class="fa fa-whatsapp"></i>
      </button>
    </div>
    <script>
      function openWhatsapp(number) {
        window.location.href = "https://api.whatsapp.com/send?phone=+91" + number;
      }
      if (localStorage.getItem("result_div") != null && localStorage.getItem("wa") != null) {
        var div = document.getElementById('result');
        document.getElementById("result-div").style.display = 'block';
        div.innerHTML = localStorage.getItem("result_div");
        div.style.display = 'block';
        document.getElementById("whatsapp-send").addEventListener('click', () => {
          window.location.href = createWhatsAppLink(localStorage.getItem("wa"));
        });
      }
      var textarea = document.getElementById('weights');
      var heightLimit = 200;
      textarea.oninput = function() {
        textarea.style.height = "";
        textarea.style.height = Math.min(textarea.scrollHeight, heightLimit) + "px";
      }

      function calculateResult() {
        var weights = document.getElementById('weights');
        var result = document.getElementById('result');
        var resultText = weights.value;
        result.innerHTML = alignBill(resultText);
        document.getElementById('result-div').style.display = 'block';
      }

      function computeTotal(quantities) {
        var weights = quantities.split('\n');
        let sum = 0;
        for (let i = 0; i < weights.length; i++) {
          sum += parseFloat(weights[i]);
        }
        return sum.toFixed(3);
      }

      function alignBill(quantities) {
        let bill = computeTotal(quantities);
        let milk_rate = parseFloat(document.getElementById('milk-price').value);
        let canWeight = parseFloat(document.getElementById('can-weight').value).toFixed(3);
        var dairy = document.getElementById('milk-seller-lakshmi-sai');
        var dairyName = "";
        let weight = parseFloat(bill - canWeight).toFixed(3);
        let totalAmount = parseFloat(weight * milk_rate).toFixed(0);
        totalAmount = Intl.NumberFormat('en-IN').format(totalAmount);
        var date1 = document.getElementById('date').value;
        var date = new Date(date1).toLocaleDateString("en-GB");
        var am_pm = document.getElementById('am-pm').value;
        if (dairy.checked) {
          dairyName = "Lakshmi Sai Dairy, Atmakur";
        }
        var weights = quantities.split('\n');
        var weightsString = "";
        var weightsString1 = "";
        for (let i = 0; i < weights.length; i++) {
          weightsString += weights[i] + "%0A";
          weightsString1 += weights[i] + " < /br>";
        }
        var result_wa = "*" + dairyName + "*%0A*Date*: " + date + " _(" + am_pm + ")_%0A%0A" + weightsString + "————————%0A*" + bill + "*%0A" + "– _" + canWeight + "_(Empty Cans)%0A——————————%0A_*" + weight + "*_ × " + milk_rate + "%0A———————%0A*₹ " + totalAmount + "/-*";
        var result_div = " <b> "+dairyName+" </b> </br> <b> Date </b>: "+date+"  <i> ("+am_pm+") </i> </br> < /br>"+weightsString1+"------------- </br> <b> "+bill+" </b> </br>"+"–  <i> "+canWeight+" </b> <i> (Empty Cans) </i> </br>------------- </br>"+weight+" × "+milk_rate+" </br>------------- </br> <b> ₹"+totalAmount+" / - </b>";
        addToDB(date1, dairyName, weights, bill, canWeight, milk_rate, totalAmount, am_pm);
        addToLS(result_div, result_wa);
        document.getElementById('whatsapp-send').addEventListener('click', () => {
          window.location.href = createWhatsAppLink(result_wa);
        });
        return result_div;
      }

      function createWhatsAppLink(message) {
        return "whatsapp://send?text=" + message;
      }

      function addToLS(div, wa) {
        localStorage.setItem("result_div", div);
        localStorage.setItem("wa", wa);
      }

      function addToDB(date, milkpartner, weights, bill, canweight, milkrate, totalBill, am_pm) {
        var db = firebase.firestore();
        db.collection("Milk Biller").doc(date).set({
          Date: date,
          AM_PM: am_pm,
          Milk_Partner: milkpartner,
          Weights: weights,
          Cans_Count: weights.length,
          Bill_Without_Can_Weight: bill,
          Can_Weight: canweight,
          Milk_Rate_Per_Litre: milkrate,
          Total_Bill: totalBill
        }).then(() => {
          console.log("Document successfully written!");
        }).catch((error) => {
          console.error("Error writing document: ", error);
        });
      }

      function initDB() {
        const firebaseConfig = {
          apiKey: "AIzaSyABU3wrmKgVumYiW6MVBWn5CFg20k2LkiE",
          authDomain: "srivenkataramanamilk-products.firebaseapp.com",
          databaseURL: "https://srivenkataramanamilk-products-default-rtdb.firebaseio.com",
          projectId: "srivenkataramanamilk-products",
          storageBucket: "srivenkataramanamilk-products.appspot.com",
          messagingSenderId: "305866360345",
          appId: "1:305866360345:web:3919e57a4360fd2cdb0c88",
          measurementId: "G-LCHPSC45B5"
        };
        firebase.initializeApp(firebaseConfig);
      }
      initDB();
    </script>
  </body>
</html>
